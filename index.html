            enableControls() {
                this.elements.resetSessionBtn.disabled = false;
                this.elements.suspendBtn.disabled = false;
                this.elements.disconnectBtn.disabled = false;
                this.elements.fullscreenBtn.disabled = false;
                document.getElementById('validateBtn').disabled = false;
            }

            async applyLmsProfile(profileId) {
                if (!profileId || !this.currentSessionId) return;
                
                try {
                    const result = await window.electronAPI.applyLmsProfile(this.currentSessionId, profileId);
                    if (result.success) {
                        this.logApiCall('system', `Applied ${result.profile} profile`);
                        this.setStatus(`Applied ${result.profile} settings`, 'success');
                    }
                } catch (error) {
                    this.showError(`Failed to apply LMS profile: ${error.message}`);
                }
            }

            async validateScormPackage() {
                if (!this.currentCoursePath) {
                    this.showError('No course loaded to validate');
                    return;
                }

                try {
                    this.setStatus('Validating SCORM package...');
                    const validation = await window.electronAPI.validateScormCompliance(this.currentCoursePath);
                    const analysis = await window.electronAPI.analyzeScormContent(this.currentCoursePath);
                    
                    this.showValidationResults(validation, analysis);
                } catch (error) {
                    this.showError(`Validation failed: ${error.message}`);
                }
            }

            showValidationResults(validation, analysis) {
                let resultsWindow;
                try {
                    resultsWindow = window.open('', 'validation', 'width=600,height=700,scrollbars=yes');
                    if (!resultsWindow) {
                        // Fallback if popup blocked
                        this.showError('Popup blocked. Please allow popups to view validation results.');
                        return;
                    }
                } catch (error) {
                    this.showError('Unable to open validation results window.');
                    return;
                }
                
                const formatSize = (bytes) => {
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    if (bytes === 0) return '0 Bytes';
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
                };

                // SECURITY: Escape HTML to prevent XSS
                const escapeHtml = (unsafe) => {
                    return unsafe
                         .replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
                };

                try {
                    resultsWindow.document.write(`
                    <html>
                        <head>
                            <title>SCORM Validation Results</title>
                            <meta charset="UTF-8">
                            <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'unsafe-inline'; style-src 'unsafe-inline';">
                            <style>
                                body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f5f5f5; }
                                .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                                .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
                                .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
                                .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
                                .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
                                .section { margin: 20px 0; }
                                .section h3 { color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
                                ul { padding-left: 20px; }
                                li { margin: 5px 0; word-break: break-word; }
                                .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
                                .stat-item { background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center; }
                                .stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
                                .stat-label { font-size: 12px; color: #6c757d; text-transform: uppercase; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <h2>üîç SCORM Package Validation Report</h2>
                                
                                <div class="status ${validation.valid ? 'success' : 'error'}">
                                    <strong>${validation.valid ? '‚úÖ SCORM Package Valid' : '‚ùå SCORM Package Invalid'}</strong>
                                    ${validation.scormVersion ? `<br>SCORM Version: ${escapeHtml(validation.scormVersion)}` : ''}
                                </div>

                                ${validation.errors.length > 0 ? `
                                    <div class="section">
                                        <h3>‚ùå Errors</h3>
                                        <ul>
                                            ${validation.errors.map(error => `<li>${escapeHtml(error)}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}

                                ${validation.warnings.length > 0 ? `
                                    <div class="section">
                                        <h3>‚ö†Ô∏è Warnings</h3>
                                        <ul>
                                            ${validation.warnings.map(warning => `<li>${escapeHtml(warning)}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}

                                <div class="section">
                                    <h3>üìä Package Analysis</h3>
                                    <div class="stats">
                                        <div class="stat-item">
                                            <div class="stat-value">${analysis.fileCount}</div>
                                            <div class="stat-label">Total Files</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value">${formatSize(analysis.totalSize)}</div>
                                            <div class="stat-label">Package Size</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value">${analysis.hasVideo ? '‚úÖ' : '‚ùå'}</div>
                                            <div class="stat-label">Has Video</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value">${analysis.hasAudio ? '‚úÖ' : '‚ùå'}</div>
                                            <div class="stat-label">Has Audio</div>
                                        </div>
                                    </div>
                                </div>

                                ${Object.keys(analysis.fileTypes).length > 0 ? `
                                    <div class="section">
                                        <h3>üìÅ File Types</h3>
                                        <ul>
                                            ${Object.entries(analysis.fileTypes).map(([ext, count]) => 
                                                `<li>${escapeHtml(ext || 'No extension')}: ${count} files</li>`
                                            ).join('')}
                                        </ul>
                                    </div>
                                ` : ''}

                                ${analysis.potentialIssues.length > 0 ? `
                                    <div class="section">
                                        <h3>‚ö†Ô∏è Potential Issues</h3>
                                        <ul>
                                            ${analysis.potentialIssues.map(issue => `<li>${escapeHtml(issue)}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}

                                ${analysis.mediaFiles.length > 0 ? `
                                    <div class="section">
                                        <h3>üé• Media Files</h3>
                                        <ul>
                                            ${analysis.mediaFiles.slice(0, 10).map(file => `<li>${escapeHtml(file)}</li>`).join('')}
                                            ${analysis.mediaFiles.length > 10 ? `<li><em>... and ${analysis.mediaFiles.length - 10} more</em></li>` : ''}
                                        </ul>
                                    </div>
                                ` : ''}‚ö†Ô∏è Potential Issues</h3>
                                        <ul>
                                            ${analysis.potentialIssues.map(issue => `<li>${issue}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}

                                ${analysis.mediaFiles.length > 0 ? `
                                    <div class="section">
                                        <h3>üé• Media Files</h3>
                                        <ul>
                                            ${analysis.mediaFiles.slice(0, 10).map(file => `<li>${file}</li>`).join('')}
                                            ${analysis.mediaFiles.length > 10 ? `<li><em>... and ${analysis.mediaFiles.length - 10} more</em></li>` : ''}
                                        </ul>
                                    </div>
                                ` : ''}

                                <div class="section">
                                    <h3>üí° Recommendations for Litmos LMS</h3>
                                    <ul>
                                        <li>‚úÖ Package size under 100MB for optimal loading</li>
                                        <li>‚úÖ Use modern web standards (HTML5, CSS3, ES6)</li>
                                        <li>‚úÖ Avoid Flash content (not supported)</li>
                                        <li>‚úÖ Test suspend/resume functionality thoroughly</li>
                                        <li>‚úÖ Implement proper SCORM API error handling</li>
                                        <li>‚úÖ Keep suspend_data under 4KB limit</li>
                                        <li>‚úÖ Use relative paths for all resources</li>
                                        <li>‚úÖ Test on mobile devices if applicable</li>
                                    </ul>
                                </div>

                                <div class="section">
                                    <h3>üîß Next Steps</h3>
                                    <ol>
                                        <li>Fix any errors shown above</li>
                                        <li>Test with different LMS profiles in this tool</li>
                                        <li>Run the automated test scenarios</li>
                                        <li>Test suspend/resume functionality</li>
                                        <li>Verify completion and scoring work correctly</li>
                                        <li>Upload to Litmos test environment</li>
                                    </ol>
                                </div>

                                <button onclick="window.close()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 20px;">Close Report</button>
                            </div>
                        </body>
                    </html>
                `);
                    resultsWindow.document.close(); // SECURITY: Close document to prevent further writes
                } catch (error) {
                    console.error('Error writing to validation window:', error);
                    if (resultsWindow) {
                        resultsWindow.close();
                    }
                    this.showError('Failed to display validation results.');
                }
            }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Course Preview & Testing Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            display: grid;
            grid-template-columns: 1fr 300px;
            min-height: 700px;
        }

        .course-panel {
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .course-info {
            background: white;
            padding: 20px;
            border-left: 4px solid #007bff;
            margin: 10px 20px;
            border-radius: 0 8px 8px 0;
        }

        .course-info h3 {
            color: #007bff;
            margin-bottom: 5px;
        }

        .course-info p {
            margin: 5px 0;
            color: #666;
            font-size: 13px;
        }

        .preview-area {
            position: relative;
            flex: 1;
            background: #f8f9fa;
        }

        .preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .no-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            text-align: center;
        }

        .no-content .icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .sidebar {
            background: #f8f9fa;
            border-left: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            background: #343a40;
            color: white;
            padding: 15px;
            font-weight: bold;
            font-size: 14px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-section {
            border-bottom: 1px solid #e9ecef;
        }

        .sidebar-section-header {
            background: #e9ecef;
            padding: 10px 15px;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
            color: #495057;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-section-header:hover {
            background: #dee2e6;
        }

        .sidebar-section-content {
            padding: 15px;
            font-size: 12px;
        }

        .sidebar-section-content.collapsed {
            display: none;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        .status-indicator.suspended {
            background: #ffc107;
        }

        .data-item {
            margin-bottom: 8px;
            padding: 5px;
            background: white;
            border-radius: 3px;
            border-left: 3px solid #007bff;
        }

        .data-item.changed {
            border-left-color: #28a745;
            animation: highlight 2s ease-out;
        }

        @keyframes highlight {
            from { background: #d4edda; }
            to { background: white; }
        }

        .data-label {
            font-weight: bold;
            color: #495057;
        }

        .data-value {
            color: #6c757d;
            word-break: break-all;
        }

        .api-log {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
        }

        .api-call {
            margin-bottom: 5px;
            padding: 3px 5px;
            border-radius: 2px;
        }

        .api-call.get {
            background: #e3f2fd;
        }

        .api-call.set {
            background: #f3e5f5;
        }

        .api-call.commit {
            background: #e8f5e8;
        }

        .api-call.error {
            background: #ffebee;
            color: #c62828;
        }

        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .simulation-controls {
            padding: 15px;
            background: #fff3cd;
            border-top: 1px solid #ffeaa7;
        }

        .simulation-controls h4 {
            margin-bottom: 10px;
            color: #856404;
        }

        .sim-btn {
            margin: 5px 5px 5px 0;
            padding: 5px 10px;
            font-size: 11px;
        }

        .progress-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 10px 20px;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
            display: none;
        }

        .error.show {
            display: block;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .sidebar {
                border-left: none;
                border-top: 1px solid #e9ecef;
                max-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ SCORM Testing & Preview Tool</h1>
            <p>Test your SCORM courses with full LMS simulation and debugging</p>
        </div>

        <div class="main-content">
            <div class="course-panel">
                <div class="toolbar">
                    <button class="btn" id="loadZipBtn">
                        üì¶ Load SCORM Package
                    </button>
                    
                    <button class="btn btn-secondary" id="loadFolderBtn">
                        üìÅ Load Folder
                    </button>

                    <select class="btn" id="lmsProfileSelect" style="background: #17a2b8; margin: 0 10px;">
                        <option value="">Choose LMS Profile...</option>
                        <option value="litmos">Litmos LMS</option>
                        <option value="moodle">Moodle</option>
                        <option value="scormcloud">SCORM Cloud</option>
                        <option value="generic">Generic LMS</option>
                    </select>
                    
                    <button class="btn btn-success" id="resetSessionBtn" disabled>
                        üîÑ Reset Session
                    </button>
                    
                    <button class="btn btn-warning" id="suspendBtn" disabled>
                        ‚è∏Ô∏è Suspend
                    </button>
                    
                    <button class="btn btn-danger" id="disconnectBtn" disabled>
                        üîå Disconnect
                    </button>
                    
                    <button class="btn btn-secondary" id="validateBtn" disabled>
                        ‚úÖ Validate SCORM
                    </button>
                    
                    <button class="btn btn-secondary" id="fullscreenBtn" disabled>
                        ‚õ∂ Fullscreen
                    </button>
                </div>

                <div class="error" id="error"></div>

                <div class="course-info" id="courseInfo" style="display: none;">
                    <h3 id="courseTitle">Course Title</h3>
                    <p><strong>Version:</strong> <span id="courseVersion">N/A</span></p>
                    <p><strong>SCORM Version:</strong> <span id="scormVersion">N/A</span></p>
                    <p><strong>Session:</strong> <span id="sessionId">N/A</span></p>
                    <p><strong>Status:</strong> <span class="status-indicator connected" id="connectionStatus"></span><span id="connectionText">Connected</span></p>
                </div>

                <div class="preview-area">
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Loading SCORM course...</p>
                    </div>

                    <iframe class="preview-frame" id="previewFrame" style="display: none;"></iframe>

                    <div class="no-content" id="noContent">
                        <div class="icon">üéì</div>
                        <h3>No Course Loaded</h3>
                        <p>Load a SCORM package to begin testing with full LMS simulation.</p>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-header">
                    SCORM Data & Debug Panel
                </div>
                
                <div class="sidebar-content">
                    <div class="sidebar-section">
                        <div class="sidebar-section-header" onclick="toggleSection('learnerData')">
                            üë§ Learner Data
                            <span id="learnerDataToggle">‚ñº</span>
                        </div>
                        <div class="sidebar-section-content" id="learnerDataContent">
                            <div class="data-item">
                                <div class="data-label">Student ID:</div>
                                <div class="data-value" id="studentId">test_user_001</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Student Name:</div>
                                <div class="data-value" id="studentName">Test User</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Mode:</div>
                                <div class="data-value" id="lessonMode">normal</div>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-section-header" onclick="toggleSection('progress')">
                            üìä Progress & Scoring
                            <span id="progressToggle">‚ñº</span>
                        </div>
                        <div class="sidebar-section-content" id="progressContent">
                            <div class="data-item">
                                <div class="data-label">Status:</div>
                                <div class="data-value" id="lessonStatus">incomplete</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Score:</div>
                                <div class="data-value" id="scoreRaw">Not set</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Progress:</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                                </div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Location:</div>
                                <div class="data-value" id="lessonLocation">Not set</div>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-section-header" onclick="toggleSection('session')">
                            ‚è±Ô∏è Session Data
                            <span id="sessionToggle">‚ñº</span>
                        </div>
                        <div class="sidebar-section-content" id="sessionContent">
                            <div class="data-item">
                                <div class="data-label">Session Time:</div>
                                <div class="data-value" id="sessionTime">00:00:00</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Total Time:</div>
                                <div class="data-value" id="totalTime">00:00:00</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Suspend Data:</div>
                                <div class="data-value" id="suspendData">Empty</div>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-section-header" onclick="toggleSection('interactions')">
                            üí¨ Interactions
                            <span id="interactionsToggle">‚ñº</span>
                        </div>
                        <div class="sidebar-section-content" id="interactionsContent">
                            <div id="interactionsList">No interactions recorded</div>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-section-header" onclick="toggleSection('apiLog')">
                            üîç API Call Log
                            <span id="apiLogToggle">‚ñº</span>
                        </div>
                        <div class="sidebar-section-content" id="apiLogContent">
                            <div class="api-log" id="apiLog">
                                <div class="api-call">Ready for API calls...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="simulation-controls">
                    <h4>üéÆ LMS Simulation & Testing</h4>
                    <button class="btn btn-secondary sim-btn" onclick="simulateNetworkDelay()">‚è≥ Network Delay</button>
                    <button class="btn btn-secondary sim-btn" onclick="simulateTimeout()">‚è∞ Timeout</button>
                    <button class="btn btn-secondary sim-btn" onclick="forceComplete()">‚úÖ Force Complete</button>
                    <button class="btn btn-secondary sim-btn" onclick="runTestScenario('quick-completion')">üèÉ Quick Complete</button>
                    <button class="btn btn-secondary sim-btn" onclick="runTestScenario('suspend-resume')">‚è∏Ô∏è Suspend Test</button>
                    <button class="btn btn-secondary sim-btn" onclick="runTestScenario('multiple-attempts')">üîÑ Multi Attempts</button>
                    <button class="btn btn-secondary sim-btn" onclick="runTestScenario('interaction-heavy')">üí¨ Heavy Interactions</button>
                    <button class="btn btn-secondary sim-btn" onclick="clearData()">üóëÔ∏è Clear Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class EnhancedScormPreview {
            constructor() {
                this.currentSessionId = null;
                this.currentCoursePath = null;
                this.sessionStartTime = null;
                this.sessionTimer = null;
                this.isConnected = true;
                this.networkDelay = 0;
                
                // BUG FIX: Track cleanup functions for proper disposal
                this.cleanupFunctions = [];
                
                this.initializeElements();
                this.bindEvents();
                this.startSessionTimer();
                
                // BUG FIX: Setup cleanup on window unload
                this.setupCleanup();
            }

            setupCleanup() {
                // BUG FIX: Cleanup when window is closed or refreshed
                window.addEventListener('beforeunload', () => {
                    this.cleanup();
                });
                
                window.addEventListener('unload', () => {
                    this.cleanup();
                });
                
                // BUG FIX: Cleanup on visibility change (tab switching)
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pauseTimers();
                    } else {
                        this.resumeTimers();
                    }
                });
            }

            bindEvents() {
                // BUG FIX: Store event handlers for proper cleanup
                this.eventHandlers = {
                    loadZip: () => this.loadScormPackage(),
                    loadFolder: () => this.loadScormFolder(),
                    resetSession: () => this.resetSession(),
                    suspend: () => this.suspendSession(),
                    disconnect: () => this.toggleConnection(),
                    fullscreen: () => this.toggleFullscreen(),
                    profileChange: (e) => this.applyLmsProfile(e.target.value),
                    validate: () => this.validateScormPackage(),
                    frameLoad: () => {
                        this.hideLoading();
                        this.logApiCall('system', 'Course loaded successfully');
                    },
                    frameError: () => {
                        this.hideLoading();
                        this.showError('Failed to load course content');
                    }
                };

                // BUG FIX: Add event listeners with proper cleanup tracking
                this.elements.loadZipBtn.addEventListener('click', this.eventHandlers.loadZip);
                this.elements.loadFolderBtn.addEventListener('click', this.eventHandlers.loadFolder);
                this.elements.resetSessionBtn.addEventListener('click', this.eventHandlers.resetSession);
                this.elements.suspendBtn.addEventListener('click', this.eventHandlers.suspend);
                this.elements.disconnectBtn.addEventListener('click', this.eventHandlers.disconnect);
                this.elements.fullscreenBtn.addEventListener('click', this.eventHandlers.fullscreen);
                
                // BUG FIX: Add new event listeners with cleanup
                if (this.elements.lmsProfileSelect) {
                    this.elements.lmsProfileSelect.addEventListener('change', this.eventHandlers.profileChange);
                }
                if (this.elements.validateBtn) {
                    this.elements.validateBtn.addEventListener('click', this.eventHandlers.validate);
                }

                this.elements.previewFrame.addEventListener('load', this.eventHandlers.frameLoad);
                this.elements.previewFrame.addEventListener('error', this.eventHandlers.frameError);

                // BUG FIX: Setup menu event listener with proper cleanup
                if (window.electronAPI?.onMenuEvent) {
                    const menuCleanup = window.electronAPI.onMenuEvent((event, data) => {
                        switch(event) {
                            case 'load-package':
                                this.loadScormPackage();
                                break;
                            case 'reset-session':
                                this.resetSession();
                                break;
                            case 'simulate':
                                this.handleSimulation(data);
                                break;
                            case 'fullscreen':
                                this.toggleFullscreen();
                                break;
                        }
                    });
                    
                    // BUG FIX: Store cleanup function
                    if (typeof menuCleanup === 'function') {
                        this.cleanupFunctions.push(menuCleanup);
                    }
                }
            }

            // BUG FIX: Comprehensive cleanup method
            cleanup() {
                try {
                    // Stop timers
                    if (this.sessionTimer) {
                        clearInterval(this.sessionTimer);
                        this.sessionTimer = null;
                    }

                    // Remove event listeners
                    if (this.eventHandlers && this.elements) {
                        this.elements.loadZipBtn?.removeEventListener('click', this.eventHandlers.loadZip);
                        this.elements.loadFolderBtn?.removeEventListener('click', this.eventHandlers.loadFolder);
                        this.elements.resetSessionBtn?.removeEventListener('click', this.eventHandlers.resetSession);
                        this.elements.suspendBtn?.removeEventListener('click', this.eventHandlers.suspend);
                        this.elements.disconnectBtn?.removeEventListener('click', this.eventHandlers.disconnect);
                        this.elements.fullscreenBtn?.removeEventListener('click', this.eventHandlers.fullscreen);
                        
                        if (this.elements.lmsProfileSelect) {
                            this.elements.lmsProfileSelect.removeEventListener('change', this.eventHandlers.profileChange);
                        }
                        if (this.elements.validateBtn) {
                            this.elements.validateBtn.removeEventListener('click', this.eventHandlers.validate);
                        }

                        this.elements.previewFrame?.removeEventListener('load', this.eventHandlers.frameLoad);
                        this.elements.previewFrame?.removeEventListener('error', this.eventHandlers.frameError);
                    }

                    // BUG FIX: Call registered cleanup functions
                    this.cleanupFunctions.forEach(cleanup => {
                        try {
                            cleanup();
                        } catch (error) {
                            console.warn('Cleanup function failed:', error);
                        }
                    });
                    this.cleanupFunctions = [];

                    // BUG FIX: Terminate SCORM session if active
                    if (this.currentSessionId && window.API) {
                        try {
                            window.API.LMSFinish('');
                        } catch (error) {
                            console.warn('Failed to terminate SCORM session:', error);
                        }
                    }

                    console.log('ScormPreview cleanup completed');
                } catch (error) {
                    console.error('Error during cleanup:', error);
                }
            }

            // BUG FIX: Pause timers when tab is hidden
            pauseTimers() {
                if (this.sessionTimer) {
                    clearInterval(this.sessionTimer);
                    this.sessionTimer = null;
                }
            }

            // BUG FIX: Resume timers when tab becomes visible
            resumeTimers() {
                if (!this.sessionTimer && this.sessionStartTime) {
                    this.startSessionTimer();
                }
            }

            initializeElements() {
                this.elements = {
                    loadZipBtn: document.getElementById('loadZipBtn'),
                    loadFolderBtn: document.getElementById('loadFolderBtn'),
                    resetSessionBtn: document.getElementById('resetSessionBtn'),
                    suspendBtn: document.getElementById('suspendBtn'),
                    disconnectBtn: document.getElementById('disconnectBtn'),
                    fullscreenBtn: document.getElementById('fullscreenBtn'),
                    error: document.getElementById('error'),
                    courseInfo: document.getElementById('courseInfo'),
                    courseTitle: document.getElementById('courseTitle'),
                    courseVersion: document.getElementById('courseVersion'),
                    scormVersion: document.getElementById('scormVersion'),
                    sessionId: document.getElementById('sessionId'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    connectionText: document.getElementById('connectionText'),
                    loading: document.getElementById('loading'),
                    previewFrame: document.getElementById('previewFrame'),
                    noContent: document.getElementById('noContent'),
                    apiLog: document.getElementById('apiLog')
                };
            }

            bindEvents() {
                this.elements.loadZipBtn.addEventListener('click', () => this.loadScormPackage());
                this.elements.loadFolderBtn.addEventListener('click', () => this.loadScormFolder());
                this.elements.resetSessionBtn.addEventListener('click', () => this.resetSession());
                this.elements.suspendBtn.addEventListener('click', () => this.suspendSession());
                this.elements.disconnectBtn.addEventListener('click', () => this.toggleConnection());
                this.elements.fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
                
                // New event listeners
                document.getElementById('lmsProfileSelect').addEventListener('change', (e) => this.applyLmsProfile(e.target.value));
                document.getElementById('validateBtn').addEventListener('click', () => this.validateScormPackage());

                this.elements.previewFrame.addEventListener('load', () => {
                    this.hideLoading();
                    this.logApiCall('system', 'Course loaded successfully');
                });

                // Listen for menu events
                window.electronAPI?.onMenuEvent?.((event, data) => {
                    switch(event) {
                        case 'load-package':
                            this.loadScormPackage();
                            break;
                        case 'reset-session':
                            this.resetSession();
                            break;
                        case 'simulate':
                            this.handleSimulation(data);
                            break;
                        case 'fullscreen':
                            this.toggleFullscreen();
                            break;
                    }
                });
            }

            async loadScormPackage() {
                try {
                    this.showLoading();
                    this.clearError();

                    const zipPath = await window.electronAPI.selectScormPackage();
                    if (!zipPath) {
                        this.hideLoading();
                        return;
                    }

                    const extractedPath = await window.electronAPI.extractScorm(zipPath);
                    if (!extractedPath) {
                        throw new Error('Failed to extract SCORM package');
                    }

                    await this.loadCourse(extractedPath);
                } catch (error) {
                    this.hideLoading();
                    this.showError(`Error loading SCORM package: ${error.message}`);
                }
            }

            async loadScormFolder() {
                try {
                    this.showLoading();
                    this.clearError();

                    const folderPath = await window.electronAPI.selectScormFolder();
                    if (!folderPath) {
                        this.hideLoading();
                        return;
                    }

                    await this.loadCourse(folderPath);
                } catch (error) {
                    this.hideLoading();
                    this.showError(`Error loading SCORM folder: ${error.message}`);
                }
            }

            async loadCourse(coursePath) {
                try {
                    const entryPoint = await window.electronAPI.findScormEntry(coursePath);
                    if (!entryPoint) {
                        throw new Error('Could not find course entry point');
                    }

                    const courseInfo = await window.electronAPI.getCourseInfo(coursePath);
                    
                    // Initialize new session
                    this.currentSessionId = 'session_' + Date.now();
                    this.currentCoursePath = coursePath;
                    this.sessionStartTime = new Date();
                    
                    await window.electronAPI.scormInitialize(this.currentSessionId);
                    
                    this.displayCourseInfo(courseInfo);
                    this.loadCourseInFrame(entryPoint);
                    this.enableControls();
                    this.setupScormAPI();
                    
                    this.logApiCall('system', `New session initialized: ${this.currentSessionId}`);

                } catch (error) {
                    this.hideLoading();
                    this.showError(`Error loading course: ${error.message}`);
                }
            }

            loadCourseInFrame(entryPoint) {
                const fileUrl = `file:///${entryPoint.replace(/\\/g, '/')}`;
                this.elements.previewFrame.src = fileUrl;
                
                this.elements.noContent.style.display = 'none';
                this.elements.previewFrame.style.display = 'block';
            }

            displayCourseInfo(courseInfo) {
                this.elements.courseTitle.textContent = courseInfo.title;
                this.elements.courseVersion.textContent = courseInfo.version;
                this.elements.scormVersion.textContent = courseInfo.scormVersion;
                this.elements.sessionId.textContent = this.currentSessionId;
                this.elements.courseInfo.style.display = 'block';
            }

            setupScormAPI() {
                const self = this;
                
                // Performance: Cache for frequently accessed values
                const apiCache = new Map();
                const cacheTimeout = 5000; // 5 seconds
                
                // Performance: Debounce commits to avoid excessive calls
                let commitTimer = null;
                const debouncedCommit = (sessionId) => {
                    if (commitTimer) clearTimeout(commitTimer);
                    commitTimer = setTimeout(() => {
                        window.electronAPI.scormCommit(sessionId)
                            .then(result => {
                                self.logApiCall('commit', 'LMSCommit', '', result.success ? 'SUCCESS' : 'ERROR');
                            })
                            .catch(() => {
                                self.logApiCall('commit', 'LMSCommit', '', 'ERROR');
                            });
                    }, 200);
                };

                // SCORM 1.2 API with performance optimizations
                window.API = {
                    LMSInitialize: function(param) {
                        self.logApiCall('init', 'LMSInitialize', param);
                        return self.isConnected ? "true" : "false";
                    },
                    
                    LMSFinish: function(param) {
                        self.logApiCall('finish', 'LMSFinish', param);
                        if (self.isConnected) {
                            // Clear cache on finish
                            apiCache.clear();
                            window.electronAPI.scormTerminate(self.currentSessionId);
                            return "true";
                        }
                        return "false";
                    },
                    
                    LMSGetValue: function(element) {
                        if (!self.isConnected) {
                            self.logApiCall('get', 'LMSGetValue', element, 'CONNECTION_ERROR');
                            return "";
                        }

                        // Performance: Check cache first
                        const cacheKey = `get_${element}`;
                        const cached = apiCache.get(cacheKey);
                        if (cached && Date.now() - cached.timestamp < cacheTimeout) {
                            return cached.value;
                        }
                        
                        // Make async call but return synchronously (SCORM requirement)
                        let result = "";
                        try {
                            // Use a synchronous approach with cached data for immediate response
                            const promise = window.electronAPI.scormGetValue(self.currentSessionId, element);
                            
                            // For development/testing, we can use a timeout approach
                            // In production, this should be replaced with proper caching
                            let timeoutId;
                            const timeout = new Promise((_, reject) => {
                                timeoutId = setTimeout(() => reject(new Error('Timeout')), 100);
                            });
                            
                            Promise.race([promise, timeout])
                                .then(response => {
                                    clearTimeout(timeoutId);
                                    // Cache the result
                                    apiCache.set(cacheKey, {
                                        value: response.value,
                                        timestamp: Date.now()
                                    });
                                    self.updateDataDisplay(element, response.value);
                                })
                                .catch(() => {
                                    clearTimeout(timeoutId);
                                    // Use cached value if available
                                    if (cached) {
                                        result = cached.value;
                                    }
                                });
                        } catch (error) {
                            result = cached ? cached.value : "";
                        }
                        
                        self.logApiCall('get', 'LMSGetValue', element, result);
                        return result;
                    },
                    
                    LMSSetValue: function(element, value) {
                        if (!self.isConnected) {
                            self.logApiCall('set', 'LMSSetValue', `${element} = ${value}`, 'CONNECTION_ERROR');
                            return "false";
                        }
                        
                        // Performance: Update cache immediately
                        const cacheKey = `get_${element}`;
                        apiCache.set(cacheKey, {
                            value: value,
                            timestamp: Date.now()
                        });
                        
                        // Make async call
                        window.electronAPI.scormSetValue(self.currentSessionId, element, value)
                            .then(response => {
                                self.updateDataDisplay(element, value);
                                self.logApiCall('set', 'LMSSetValue', `${element} = ${value}`, response.success ? 'SUCCESS' : 'ERROR');
                                
                                // Auto-commit critical data
                                if (element.includes('lesson_status') || element.includes('score') || element.includes('completion_status')) {
                                    debouncedCommit(self.currentSessionId);
                                }
                            })
                            .catch(() => {
                                self.logApiCall('set', 'LMSSetValue', `${element} = ${value}`, 'ERROR');
                            });
                        
                        return "true"; // Return immediately as per SCORM spec
                    },
                    
                    LMSCommit: function(param) {
                        if (!self.isConnected) {
                            self.logApiCall('commit', 'LMSCommit', param, 'CONNECTION_ERROR');
                            return "false";
                        }
                        
                        // Performance: Clear cache on commit to force fresh data
                        apiCache.clear();
                        debouncedCommit(self.currentSessionId);
                        
                        return "true"; // Return immediately as per SCORM spec
                    },
                    
                    LMSGetLastError: function() {
                        return self.isConnected ? "0" : "301";
                    },
                    
                    LMSGetErrorString: function(errorCode) {
                        const errors = {
                            "0": "No error",
                            "301": "General Get Failure",
                            "351": "General Set Failure",
                            "401": "Undefined Data Model",
                            "405": "Incorrect Data Type"
                        };
                        return errors[errorCode] || "Unknown error";
                    },
                    
                    LMSGetDiagnostic: function(errorCode) {
                        return `Diagnostic for error ${errorCode}`;
                    }
                };

                // SCORM 2004 API (similar structure)
                window.API_1484_11 = {
                    Initialize: function(param) {
                        return window.API.LMSInitialize(param);
                    },
                    Terminate: function(param) {
                        return window.API.LMSFinish(param);
                    },
                    GetValue: function(element) {
                        return window.API.LMSGetValue(element);
                    },
                    SetValue: function(element, value) {
                        return window.API.LMSSetValue(element, value);
                    },
                    Commit: function(param) {
                        return window.API.LMSCommit(param);
                    },
                    GetLastError: function() {
                        return window.API.LMSGetLastError();
                    },
                    GetErrorString: function(errorCode) {
                        return window.API.LMSGetErrorString(errorCode);
                    },
                    GetDiagnostic: function(errorCode) {
                        return window.API.LMSGetDiagnostic(errorCode);
                    }
                };
            }

            async simulateDelay() {
                if (this.networkDelay > 0) {
                    await new Promise(resolve => setTimeout(resolve, this.networkDelay));
                }
            }

            updateDataDisplay(element, value) {
                // Update sidebar data displays
                const updates = {
                    'cmi.core.lesson_status': 'lessonStatus',
                    'cmi.completion_status': 'lessonStatus',
                    'cmi.core.score.raw': 'scoreRaw',
                    'cmi.score.raw': 'scoreRaw',
                    'cmi.core.lesson_location': 'lessonLocation',
                    'cmi.location': 'lessonLocation',
                    'cmi.suspend_data': 'suspendData',
                    'cmi.core.session_time': 'sessionTime',
                    'cmi.session_time': 'sessionTime',
                    'cmi.core.total_time': 'totalTime',
                    'cmi.total_time': 'totalTime'
                };

                if (updates[element]) {
                    const elementId = updates[element];
                    const displayElement = document.getElementById(elementId);
                    if (displayElement) {
                        displayElement.textContent = value || 'Not set';
                        displayElement.parentElement.classList.add('changed');
                        setTimeout(() => {
                            displayElement.parentElement.classList.remove('changed');
                        }, 2000);
                    }
                }

                // Update progress bar for score
                if (element.includes('score.raw') && value) {
                    const score = parseFloat(value);
                    if (!isNaN(score) && score >= 0 && score <= 100) {
                        const progressFill = document.getElementById('progressFill');
                        progressFill.style.width = `${score}%`;
                        progressFill.textContent = `${score}%`;
                    }
                }
            }

            logApiCall(type, method, parameter, result) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `api-call ${type}`;
                logEntry.innerHTML = `<strong>${timestamp}</strong> ${method}(${parameter || ''}) ‚Üí ${result || ''}`;
                
                this.elements.apiLog.appendChild(logEntry);
                this.elements.apiLog.scrollTop = this.elements.apiLog.scrollHeight;

                // Keep only last 50 entries
                while (this.elements.apiLog.children.length > 50) {
                    this.elements.apiLog.removeChild(this.elements.apiLog.firstChild);
                }
            }

            async resetSession() {
                if (this.currentSessionId) {
                    await window.electronAPI.resetSession(this.currentSessionId);
                    this.currentSessionId = 'session_' + Date.now();
                    await window.electronAPI.scormInitialize(this.currentSessionId);
                    
                    // Reset displays
                    document.getElementById('lessonStatus').textContent = 'incomplete';
                    document.getElementById('scoreRaw').textContent = 'Not set';
                    document.getElementById('lessonLocation').textContent = 'Not set';
                    document.getElementById('suspendData').textContent = 'Empty';
                    document.getElementById('progressFill').style.width = '0%';
                    document.getElementById('progressFill').textContent = '0%';
                    
                    this.elements.apiLog.innerHTML = '<div class="api-call">Session reset - Ready for API calls...</div>';
                    this.logApiCall('system', `Session reset: ${this.currentSessionId}`);
                    
                    // Reload course
                    if (this.elements.previewFrame.src) {
                        this.elements.previewFrame.src = this.elements.previewFrame.src;
                    }
                }
            }

            suspendSession() {
                this.logApiCall('system', 'Session suspended by user');
                // You could add additional suspend logic here
            }

            toggleConnection() {
                this.isConnected = !this.isConnected;
                
                if (this.isConnected) {
                    this.elements.connectionStatus.className = 'status-indicator connected';
                    this.elements.connectionText.textContent = 'Connected';
                    this.elements.disconnectBtn.innerHTML = 'üîå Disconnect';
                    this.logApiCall('system', 'Connection restored');
                } else {
                    this.elements.connectionStatus.className = 'status-indicator disconnected';
                    this.elements.connectionText.textContent = 'Disconnected';
                    this.elements.disconnectBtn.innerHTML = 'üîó Connect';
                    this.logApiCall('system', 'Connection lost - API calls will fail');
                }
            }

            toggleFullscreen() {
                if (this.elements.previewFrame.requestFullscreen) {
                    this.elements.previewFrame.requestFullscreen();
                }
            }

            startSessionTimer() {
                // BUG FIX: Clear existing timer to prevent multiple timers
                if (this.sessionTimer) {
                    clearInterval(this.sessionTimer);
                    this.sessionTimer = null;
                }

                this.sessionTimer = setInterval(() => {
                    // BUG FIX: Check if session is still active
                    if (!this.sessionStartTime || !this.currentSessionId) {
                        clearInterval(this.sessionTimer);
                        this.sessionTimer = null;
                        return;
                    }

                    // BUG FIX: Check if page is still visible
                    if (document.hidden) {
                        return; // Don't update timer when tab is hidden
                    }

                    try {
                        const elapsed = new Date() - this.sessionStartTime;
                        const hours = Math.floor(elapsed / 3600000);
                        const minutes = Math.floor((elapsed % 3600000) / 60000);
                        const seconds = Math.floor((elapsed % 60000) / 1000);
                        
                        const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        const sessionTimeElement = document.getElementById('sessionTime');
                        
                        // BUG FIX: Check if element still exists
                        if (sessionTimeElement) {
                            sessionTimeElement.textContent = timeString;
                        } else {
                            // Element gone - stop timer
                            clearInterval(this.sessionTimer);
                            this.sessionTimer = null;
                        }
                    } catch (error) {
                        console.warn('Session timer error:', error);
                        clearInterval(this.sessionTimer);
                        this.sessionTimer = null;
                    }
                }, 1000);
            }

            // BUG FIX: Method to stop session timer
            stopSessionTimer() {
                if (this.sessionTimer) {
                    clearInterval(this.sessionTimer);
                    this.sessionTimer = null;
                }
            }

            enableControls() {
                this.elements.resetSessionBtn.disabled = false;
                this.elements.suspendBtn.disabled = false;
                this.elements.disconnectBtn.disabled = false;
                this.elements.fullscreenBtn.disabled = false;
            }

            showLoading() {
                this.elements.loading.classList.add('show');
            }

            hideLoading() {
                this.elements.loading.classList.remove('show');
            }

            showError(message) {
                this.elements.error.textContent = message;
                this.elements.error.classList.add('show');
            }

            clearError() {
                this.elements.error.classList.remove('show');
            }
        }

        // Global functions for simulation controls
        async function runTestScenario(scenarioType) {
            const app = window.scormApp;
            if (!app.currentSessionId) {
                app.showError('No active session to test');
                return;
            }

            try {
                app.setStatus(`Running ${scenarioType} test scenario...`);
                const result = await window.electronAPI.runTestScenario(app.currentSessionId, scenarioType);
                if (result.success) {
                    app.logApiCall('system', `Test scenario completed: ${result.result}`);
                    app.setStatus(`‚úÖ ${result.result}`, 'success');
                } else {
                    app.showError(`Test scenario failed: ${result.error}`);
                }
            } catch (error) {
                app.showError(`Test scenario error: ${error.message}`);
            }
        }

        function simulateNetworkDelay() {
            const app = window.scormApp;
            app.networkDelay = app.networkDelay > 0 ? 0 : 1000;
            app.logApiCall('system', `Network delay ${app.networkDelay > 0 ? 'enabled' : 'disabled'} (${app.networkDelay}ms)`);
        }

        function simulateTimeout() {
            const app = window.scormApp;
            app.logApiCall('system', 'Simulating connection timeout...');
            app.toggleConnection();
            setTimeout(() => {
                app.toggleConnection();
            }, 5000);
        }

        function forceComplete() {
            const app = window.scormApp;
            if (app.currentSessionId) {
                window.electronAPI.scormSetValue(app.currentSessionId, 'cmi.core.lesson_status', 'completed');
                window.electronAPI.scormSetValue(app.currentSessionId, 'cmi.completion_status', 'completed');
                app.updateDataDisplay('cmi.core.lesson_status', 'completed');
                app.logApiCall('system', 'Force completed by user');
            }
        }

        function clearData() {
            const app = window.scormApp;
            app.resetSession();
        }

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const toggle = document.getElementById(sectionId + 'Toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '‚ñº';
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '‚ñ∂';
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.scormApp = new EnhancedScormPreview();
        });
    </script>
</body>
</html>