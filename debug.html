<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM Debug Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2d2d30;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            color: #ffffff;
            font-size: 16px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn:hover {
            background: #1177bb;
        }

        .btn-secondary {
            background: #5a5a5a;
        }

        .btn-secondary:hover {
            background: #6a6a6a;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs {
            background: #2d2d30;
            display: flex;
            border-bottom: 1px solid #3e3e42;
        }

        .tab {
            padding: 8px 15px;
            cursor: pointer;
            border-right: 1px solid #3e3e42;
            background: #252526;
            color: #cccccc;
            font-size: 13px;
        }

        .tab:hover {
            background: #2a2d2e;
        }

        .tab.active {
            background: #1e1e1e;
            color: #ffffff;
            border-bottom: 2px solid #0e639c;
        }

        .tab-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th,
        .data-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #3e3e42;
        }

        .data-table th {
            background: #2d2d30;
            color: #ffffff;
            font-weight: bold;
        }

        .data-table tr:hover {
            background: #2a2d2e;
        }

        .data-table .element-name {
            font-family: 'Courier New', monospace;
            color: #9cdcfe;
        }

        .data-table .element-value {
            font-family: 'Courier New', monospace;
            color: #ce9178;
        }

        .log-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .log-controls {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .log-filter {
            background: #3c3c3c;
            border: 1px solid #5a5a5a;
            color: #d4d4d4;
            padding: 5px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        .log-entries {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-left: 3px solid transparent;
            padding-left: 8px;
        }

        .log-entry.api-get {
            border-left-color: #4fc3f7;
            color: #4fc3f7;
        }

        .log-entry.api-set {
            border-left-color: #ba68c8;
            color: #ba68c8;
        }

        .log-entry.api-commit {
            border-left-color: #81c784;
            color: #81c784;
        }

        .log-entry.api-init {
            border-left-color: #ffd54f;
            color: #ffd54f;
        }

        .log-entry.api-finish {
            border-left-color: #ff8a65;
            color: #ff8a65;
        }

        .log-entry.system {
            border-left-color: #90a4ae;
            color: #90a4ae;
        }

        .log-entry.error {
            border-left-color: #f44336;
            color: #f44336;
        }

        .timestamp {
            color: #616161;
            margin-right: 10px;
        }

        .method {
            color: #ffffff;
            font-weight: bold;
        }

        .parameter {
            color: #9cdcfe;
        }

        .value {
            color: #ce9178;
        }

        .interactions-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .interaction-item {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            padding: 12px;
        }

        .interaction-header {
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .interaction-type {
            background: #0e639c;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }

        .interaction-details {
            font-size: 12px;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 5px 15px;
        }

        .interaction-label {
            color: #9cdcfe;
        }

        .interaction-value {
            color: #ce9178;
            font-family: 'Courier New', monospace;
        }

        .objectives-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .objective-item {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            padding: 10px;
        }

        .objective-id {
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .session-info {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .session-info h3 {
            color: #ffffff;
            margin-bottom: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 20px;
            font-size: 12px;
        }

        .info-label {
            color: #9cdcfe;
            font-weight: bold;
        }

        .info-value {
            color: #ce9178;
            font-family: 'Courier New', monospace;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: #4caf50;
            color: white;
        }

        .status-badge.terminated {
            background: #f44336;
            color: white;
        }

        .export-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #3e3e42;
        }

        .scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: #2d2d30;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: #5a5a5a;
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6a6a6a;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>üîç SCORM Debug Console</h2>
        <div class="controls">
            <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
            <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            <button class="btn btn-secondary" onclick="exportData()">üíæ Export</button>
        </div>
    </div>

    <div class="content">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('session')">üìä Session Data</div>
            <div class="tab" onclick="switchTab('interactions')">üí¨ Interactions</div>
            <div class="tab" onclick="switchTab('objectives')">üéØ Objectives</div>
            <div class="tab" onclick="switchTab('logs')">üìù API Logs</div>
        </div>

        <div id="session" class="tab-content active">
            <div class="session-info">
                <h3>Session Information</h3>
                <div class="info-grid">
                    <span class="info-label">Session ID:</span>
                    <span class="info-value" id="sessionId">Not initialized</span>
                    
                    <span class="info-label">Status:</span>
                    <span class="status-badge active" id="sessionStatus">Active</span>
                    
                    <span class="info-label">Start Time:</span>
                    <span class="info-value" id="startTime">-</span>
                    
                    <span class="info-label">Duration:</span>
                    <span class="info-value" id="duration">-</span>
                    
                    <span class="info-label">Last Commit:</span>
                    <span class="info-value" id="lastCommit">Never</span>
                </div>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>SCORM Element</th>
                        <th>Current Value</th>
                        <th>Last Modified</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="3" style="text-align: center; color: #888;">No session data available</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="interactions" class="tab-content">
            <div class="interactions-list" id="interactionsList">
                <p style="text-align: center; color: #888;">No interactions recorded</p>
            </div>
        </div>

        <div id="objectives" class="tab-content">
            <div class="objectives-list" id="objectivesList">
                <p style="text-align: center; color: #888;">No objectives set</p>
            </div>
        </div>

        <div id="logs" class="tab-content">
            <div class="log-container">
                <div class="log-controls">
                    <label for="logFilter" style="color: #cccccc;">Filter:</label>
                    <select class="log-filter" id="logFilter" onchange="filterLogs()">
                        <option value="all">All Events</option>
                        <option value="api-get">Get Values</option>
                        <option value="api-set">Set Values</option>
                        <option value="api-commit">Commits</option>
                        <option value="system">System Events</option>
                        <option value="error">Errors</option>
                    </select>
                    
                    <button class="btn btn-secondary" onclick="toggleAutoScroll()">
                        <span id="autoScrollText">üîí Auto-scroll: ON</span>
                    </button>
                </div>
                
                <div class="log-entries scrollbar" id="logEntries">
                    <div class="log-entry system">
                        <span class="timestamp">[00:00:00]</span>
                        <span class="method">SYSTEM</span>
                        Debug console initialized - waiting for SCORM activity...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ScormDebugConsole {
            constructor() {
                this.currentSession = null;
                this.autoScroll = true;
                this.logFilter = 'all';
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Listen for session events from main process
                window.electronAPI?.onSessionEvent?.((event, data) => {
                    switch(event) {
                        case 'session-initialized':
                            this.handleSessionInitialized(data);
                            break;
                        case 'api-call':
                            this.handleApiCall(data);
                            break;
                        case 'data-committed':
                            this.handleDataCommitted(data);
                            break;
                        case 'session-terminated':
                            this.handleSessionTerminated(data);
                            break;
                    }
                });
            }

            handleSessionInitialized(session) {
                this.currentSession = session;
                this.updateSessionInfo();
                this.updateDataTable();
                this.addLogEntry('system', 'Session initialized', session.id);
            }

            handleApiCall(data) {
                this.addLogEntry(
                    `api-${data.method.toLowerCase().replace('lms', '')}`,
                    data.method,
                    data.parameter,
                    data.value,
                    data.errorCode
                );
                
                if (data.method === 'SetValue') {
                    this.updateDataTable();
                }
            }

            handleDataCommitted(data) {
                this.addLogEntry('api-commit', 'Data committed to LMS', '', '', '0');
                if (this.currentSession) {
                    this.currentSession.lastCommit = data.timestamp;
                    this.updateSessionInfo();
                }
            }

            handleSessionTerminated(data) {
                this.addLogEntry('api-finish', 'Session terminated', `Duration: ${this.formatDuration(data.duration)}`);
                if (this.currentSession) {
                    this.currentSession.terminated = true;
                    this.currentSession.endTime = new Date();
                    this.updateSessionInfo();
                }
            }

            updateSessionInfo() {
                if (!this.currentSession) return;

                document.getElementById('sessionId').textContent = this.currentSession.id;
                document.getElementById('sessionStatus').textContent = this.currentSession.terminated ? 'Terminated' : 'Active';
                document.getElementById('sessionStatus').className = `status-badge ${this.currentSession.terminated ? 'terminated' : 'active'}`;
                
                if (this.currentSession.startTime) {
                    document.getElementById('startTime').textContent = new Date(this.currentSession.startTime).toLocaleString();
                    
                    const duration = (this.currentSession.endTime || new Date()) - new Date(this.currentSession.startTime);
                    document.getElementById('duration').textContent = this.formatDuration(duration);
                }
                
                if (this.currentSession.lastCommit) {
                    document.getElementById('lastCommit').textContent = new Date(this.currentSession.lastCommit).toLocaleTimeString();
                } else {
                    document.getElementById('lastCommit').textContent = 'Never';
                }
            }

            updateDataTable() {
                if (!this.currentSession) return;

                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = '';

                const importantElements = [
                    'cmi.core.student_id', 'cmi.learner_id',
                    'cmi.core.student_name', 'cmi.learner_name',
                    'cmi.core.lesson_status', 'cmi.completion_status',
                    'cmi.success_status',
                    'cmi.core.score.raw', 'cmi.score.raw',
                    'cmi.core.score.max', 'cmi.score.max',
                    'cmi.core.score.min', 'cmi.score.min',
                    'cmi.core.lesson_location', 'cmi.location',
                    'cmi.core.session_time', 'cmi.session_time',
                    'cmi.core.total_time', 'cmi.total_time',
                    'cmi.suspend_data',
                    'cmi.launch_data',
                    'cmi.progress_measure'
                ];

                // Show important elements first
                importantElements.forEach(element => {
                    if (this.currentSession.data.hasOwnProperty(element)) {
                        this.addDataRow(element, this.currentSession.data[element]);
                    }
                });

                // Show other elements
                Object.keys(this.currentSession.data).forEach(element => {
                    if (!importantElements.includes(element)) {
                        this.addDataRow(element, this.currentSession.data[element]);
                    }
                });

                if (tbody.children.length === 0) {
                    const row = tbody.insertRow();
                    row.innerHTML = '<td colspan="3" style="text-align: center; color: #888;">No data elements set</td>';
                }
            }

            addDataRow(element, value) {
                const tbody = document.getElementById('dataTableBody');
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td class="element-name">${element}</td>
                    <td class="element-value">${value || '<em>empty</em>'}</td>
                    <td>${new Date().toLocaleTimeString()}</td>
                `;
            }

            addLogEntry(type, method, parameter = '', value = '', errorCode = '') {
                const logEntries = document.getElementById('logEntries');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                
                const timestamp = new Date().toLocaleTimeString();
                let content = `<span class="timestamp">[${timestamp}]</span> <span class="method">${method}</span>`;
                
                if (parameter) {
                    content += ` <span class="parameter">${parameter}</span>`;
                }
                
                if (value) {
                    content += ` ‚Üí <span class="value">${value}</span>`;
                }
                
                if (errorCode && errorCode !== '0') {
                    content += ` <span style="color: #f44336;">[Error: ${errorCode}]</span>`;
                    entry.classList.add('error');
                }
                
                entry.innerHTML = content;
                logEntries.appendChild(entry);
                
                // Apply current filter
                if (this.logFilter !== 'all' && !entry.classList.contains(this.logFilter)) {
                    entry.style.display = 'none';
                }
                
                // Auto-scroll if enabled
                if (this.autoScroll) {
                    logEntries.scrollTop = logEntries.scrollHeight;
                }
                
                // Keep only last 1000 entries
                while (logEntries.children.length > 1000) {
                    logEntries.removeChild(logEntries.firstChild);
                }
            }

            formatDuration(milliseconds) {
                const seconds = Math.floor(milliseconds / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                
                return `${hours.toString().padStart(2, '0')}:${(minutes % 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
            }
        }

        // Global functions
        function switchTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            // Show selected tab
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function refreshData() {
            if (window.debugConsole && window.debugConsole.currentSession) {
                window.debugConsole.updateSessionInfo();
                window.debugConsole.updateDataTable();
                window.debugConsole.addLogEntry('system', 'Data refreshed manually');
            }
        }

        function clearLogs() {
            const logEntries = document.getElementById('logEntries');
            logEntries.innerHTML = '<div class="log-entry system"><span class="timestamp">[' + 
                new Date().toLocaleTimeString() + ']</span> <span class="method">SYSTEM</span> Logs cleared</div>';
        }

        function filterLogs() {
            const filter = document.getElementById('logFilter').value;
            window.debugConsole.logFilter = filter;
            
            const entries = document.querySelectorAll('.log-entry');
            entries.forEach(entry => {
                if (filter === 'all' || entry.classList.contains(filter)) {
                    entry.style.display = 'block';
                } else {
                    entry.style.display = 'none';
                }
            });
        }

        function toggleAutoScroll() {
            window.debugConsole.autoScroll = !window.debugConsole.autoScroll;
            const text = document.getElementById('autoScrollText');
            text.textContent = `üîí Auto-scroll: ${window.debugConsole.autoScroll ? 'ON' : 'OFF'}`;
        }

        function exportData() {
            if (window.debugConsole && window.debugConsole.currentSession) {
                const data = {
                    session: window.debugConsole.currentSession,
                    exportTime: new Date().toISOString(),
                    logs: Array.from(document.querySelectorAll('.log-entry')).map(entry => entry.textContent)
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `scorm-debug-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                window.debugConsole.addLogEntry('system', 'Debug data exported');
            }
        }

        // Initialize debug console
        document.addEventListener('DOMContentLoaded', () => {
            window.debugConsole = new ScormDebugConsole();
        });
    </script>
</body>
</html>
            