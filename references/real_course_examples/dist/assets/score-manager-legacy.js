!function(){function e(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function t(t){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?e(Object(o),!0).forEach(function(e){r(t,e,o[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))})}return t}function r(e,t,r){return(t=i(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,c,a,i=[],u=!0,s=!1;try{if(c=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;u=!1}else for(;!(u=(n=c.call(r)).done)&&(i.push(n.value),i.length!==t);u=!0);}catch(e){s=!0,o=e}finally{try{if(!u&&null!=r.return&&(a=r.return(),Object(a)!==a))return}finally{if(s)throw o}}return i}}(e,t)||function(e,t){if(e){if("string"==typeof e)return o(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?o(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function c(e){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c(e)}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,i(n.key),n)}}function i(e){var t=function(e,t){if("object"!=c(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=c(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==c(t)?t:t+""}System.register(["./main-legacy.js"],function(e,r){"use strict";var o,i,u;return{setters:[function(e){o=e.e,i=e.i,u=e.a}],execute:function(){e("default",new(function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.isInitialized=!1,this.config=null,this.cachedScores={}},(r=[{key:"initialize",value:function(e){if(this.isInitialized)throw new Error("[ScoreManager] Already initialized. Do not call initialize() more than once.");e&&null!==e.type&&"none"!==e.type?(this._validateConfig(e),this.config=e,this._subscribeToEvents(),this._loadExistingScores(),this.isInitialized=!0,console.log("[ScoreManager] Initialized with scoring type:",e.type)):console.log("[ScoreManager] Course scoring disabled. cmi.score.raw will not be set.")}},{key:"_validateConfig",value:function(e){if(!e.type)throw new Error('[ScoreManager] Configuration must include "type" field');var t=["average","weighted","minimum","maximum","custom"];if(!t.includes(e.type))throw new Error('[ScoreManager] Invalid scoring type "'.concat(e.type,'". Must be one of: ').concat(t.join(", ")));if(!e.sources||!Array.isArray(e.sources)||0===e.sources.length)throw new Error('[ScoreManager] Configuration must include non-empty "sources" array');if("weighted"===e.type){if(e.sources.some(function(e){return"object"!==c(e)||!e.id||"number"!=typeof e.weight}))throw new Error("[ScoreManager] Weighted scoring requires sources with {id, weight} format");var r=e.sources.reduce(function(e,t){return e+t.weight},0);if(Math.abs(r-1)>.001)throw new Error("[ScoreManager] Weights sum to ".concat(r,", not 1.0. Weights must sum exactly to 1.0. Current weights: ").concat(JSON.stringify(e.sources.map(function(e){return{id:e.id,weight:e.weight}}))))}if("custom"===e.type&&"function"!=typeof e.calculate)throw new Error('[ScoreManager] Custom scoring type requires "calculate" function')}},{key:"_subscribeToEvents",value:function(){var e=this;o.on("assessment:submitted",function(t){var r=t.assessmentId,n=t.results;n&&"number"==typeof n.scorePercentage&&e._updateSourceScore("assessment:".concat(r),n.scorePercentage)}),o.on("objective:score:updated",function(t){var r=t.objectiveId,n=t.score;"number"==typeof n&&e._updateSourceScore("objective:".concat(r),n)})}},{key:"_loadExistingScores",value:function(){var e=this;this.config&&(this.config.sources.map(function(e){return"string"==typeof e?e:e.id}).forEach(function(t){var r=n(t.split(":"),2),o=r[0],c=r[1];if("objective"===o)try{var a=i.getObjective(c);a&&"number"==typeof a.score&&(e.cachedScores[t]=a.score)}catch(f){}else if("assessment"===o)try{var s="assessment_".concat(c),l=u.getValue(s,"summary");l&&l.lastResults&&"number"==typeof l.lastResults.scorePercentage&&(e.cachedScores[t]=l.lastResults.scorePercentage)}catch(f){}}),console.log("[ScoreManager] Loaded existing scores:",this.cachedScores))}},{key:"_updateSourceScore",value:function(e,t){if(this.isInitialized&&this.config.sources.map(function(e){return"string"==typeof e?e:e.id}).includes(e)){var r=this.cachedScores[e];this.cachedScores[e]=t,console.log("[ScoreManager] Score updated: ".concat(e," = ").concat(t," (was ").concat(r||"none",")")),this._calculateAndReportScore()}}},{key:"_calculateAndReportScore",value:function(){if(this.isInitialized&&this.config){var e=this._calculateScore();if(null!==e){if(e<0||e>100)throw new Error("[ScoreManager] Calculated score ".concat(e," is out of range [0-100]. This indicates a bug in the scoring calculation."));try{var r=Math.round(100*e)/100,n=r/100;u.setValue("cmi.score.raw",String(r)),u.setValue("cmi.score.scaled",String(n)),u.setValue("cmi.score.min","0"),u.setValue("cmi.score.max","100"),console.log("[ScoreManager] Course score updated: ".concat(r,"% (scaled: ").concat(n,")")),o.emit("course:score:updated",{raw:r,scaled:n,sources:t({},this.cachedScores)})}catch(a){var c="[ScoreManager] Failed to report score to SCORM: ".concat(a.message);throw o.emit("score:error",{domain:"score",operation:"reportScore",message:c,context:{calculatedScore:e,error:a}}),a}}else console.log("[ScoreManager] Insufficient data to calculate course score")}}},{key:"_calculateScore",value:function(){var e=this,t=this.config,r=t.type,n=t.sources,o={},c=n.map(function(e){return"string"==typeof e?e:e.id});c.forEach(function(t){void 0!==e.cachedScores[t]&&(o[t]=e.cachedScores[t])});var a=Object.keys(o).length;if(c.length,0===a)return null;switch(r){case"average":return this._calculateAverage(o);case"weighted":return this._calculateWeighted(o,n);case"minimum":return this._calculateMinimum(o);case"maximum":return this._calculateMaximum(o);case"custom":return this._calculateCustom(o);default:throw new Error("[ScoreManager] Unknown scoring type: ".concat(r,". Valid types: average, weighted, custom."))}}},{key:"_calculateAverage",value:function(e){var t=Object.values(e);return 0===t.length?null:t.reduce(function(e,t){return e+t},0)/t.length}},{key:"_calculateWeighted",value:function(e,t){var r=0,n=0;return t.forEach(function(t){var o=e[t.id];void 0!==o&&(r+=o*t.weight,n+=t.weight)}),0===n?null:r/n}},{key:"_calculateMinimum",value:function(e){var t=Object.values(e);return 0===t.length?null:Math.min.apply(Math,t)}},{key:"_calculateMaximum",value:function(e){var t=Object.values(e);return 0===t.length?null:Math.max.apply(Math,t)}},{key:"_calculateCustom",value:function(e){try{var t=this.config.calculate(e);if(null==t)return null;if("number"!=typeof t||isNaN(t))throw new Error("[ScoreManager] Custom calculate function must return a number or null. Got: ".concat(c(t)));return t}catch(r){throw new Error("[ScoreManager] Error in custom calculate function: ".concat(r.message))}}},{key:"recalculate",value:function(){if(!this.isInitialized)throw new Error("[ScoreManager] Cannot recalculate: not initialized. Call initialize() first.");this._calculateAndReportScore()}},{key:"getCurrentScore",value:function(){if(!this.isInitialized)return null;var e=this._calculateScore();if(null===e)return null;var r=Math.round(100*e)/100;return{raw:r,scaled:r/100,sources:t({},this.cachedScores)}}},{key:"getSourceScores",value:function(){return t({},this.cachedScores)}}])&&a(e.prototype,r),s&&a(e,s),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,r,s}()))}}})}();
