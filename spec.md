# SCORM Tester Application & MCP Spec for AI Agents

This document provides essential, token-efficient architectural rules, design decisions, and implementation details for the SCORM Tester application. AI agents **MUST** adhere to these specifications to avoid writing redundant or misplaced code.

## 1. Universal Architectural Principles

- **Single Source of Truth**: State (e.g., SCORM session, navigation) is owned by a single, authoritative service in the main process. The GUI is a "dumb" consumer.
- **Fail-Fast**: Services **MUST NOT** silently handle errors. Operations **MUST** fail immediately and throw a structured error.
- **No Fallbacks**: If a required service is unavailable, dependent features **MUST** be disabled. The system will not "work around" failures.
- **Unidirectional Data Flow**: The main process is the master source of state. It pushes state to consumers (GUI). It **MUST NOT** query state from a consumer.
- **Strict, Structured Logging**: All logging **MUST** use the centralized logger. Direct use of `console.*` is forbidden.
- **Security First**:
    - All externally-sourced data rendered in HTML **MUST** be escaped.
    - Filesystem operations are restricted. Use `PathUtils` for all path resolutions.
    - The MCP runs SCORM content in a sandboxed environment.

## 2. Codebase Architecture & Directory Structure

Adhere to this structure to ensure code is placed correctly.

- **`src/main/`**: Main process code.
  - **`services/`**: All backend services (e.g., `ScormService`, `WindowManager`).
  - The SCORM Engine (`CAM`, `RTE`, `SN`) logic resides here.
- **`src/renderer/`**: GUI (Renderer process) code.
  - **`components/`**: All UI components.
  - **`services/`**: UI-specific services (`UIState`, `EventBus`, `ScormClient`).
  - **`boot/`**: Application startup and initialization for the renderer.
- **`src/mcp/`**: AI Agent Interface (Machine-to-Machine Control Protocol).
  - Contains the Node.js server, tool definitions (in `src/mcp/server.js`), and Electron runtime entry.
- **`src/shared/`**: Code shared between **all** processes.
  - This is the primary location for code reuse to avoid redundancy.
- **`tests/`**: All tests. Follow the existing structure for new tests.
  - **`unit/`**, **`integration/`**, **`e2e/`**.

## 3. Shared Code & Utilities (To Avoid Redundancy)

Before writing new code, check `src/shared/` for existing solutions.

- **`src/shared/constants/`**: Centralized, shared constants.
  - IPC channel names, `EventBus` event names, and other magic strings **MUST** be defined here.
- **`src/shared/utils/`**: Reusable utility functions.
  - **`logger.js`**: The only way to log.
  - **`error-handler.js`**: Central point for processing caught errors.
  - **`path-utils.js`**: For secure and consistent file path manipulation.
  - **`console-capture.js`**: Captures console output from SCORM content WebViews.
- **`src/shared/errors/`**: Custom error classes used throughout the application.
- **`src/shared/types/`**: Shared data type definitions (e.g., for IPC payloads).

## 4. System-Wide Contracts

### 4.1. Logging
- All logging **MUST** use the shared logger from `src/shared/utils/logger.js`.
- `console.*` is **FORBIDDEN**.
- Log files are generated in the Electron `userData` directory (for GUI) or `./logs/mcp/` (for MCP).

### 4.2. Error Handling
- All significant errors **MUST** be routed through the shared `ErrorHandler`.
- New custom errors **SHOULD** be defined in `src/shared/errors/`.

### 4.3. Inter-Process Communication (IPC)
- **Mechanism**: Use the centralized `IpcHandler` in `main` and `ScormClient` in `renderer`.
- **Channels**: All channel names **MUST** be defined in `src/shared/constants/`.
- **Payloads**: To avoid chattiness, use existing batched endpoints (e.g., `scorm-set-values`) where possible.

## 5. Main Process (Core) Architecture

- **State Ownership**: All SCORM and application state is owned and managed exclusively by services in the main process.
- **Key Service Responsibilities**:
    - `ScormService`: The primary orchestrator. It delegates to the specialized services below.
    - `CAM`: **Input:** `imsmanifest.xml` path. **Output:** A validated activity tree data structure and package metadata.
    - `RTE`: Manages the SCORM Data Model (`cmi.*`) for a single SCO. The source of truth for `cmi` data.
    - `SN`: **Input:** The activity tree from CAM. Manages sequencing rules, navigation state, and is the source of truth for the course's structure and flow.
    - `WindowManager`: Creates and manages all `BrowserWindow` instances.
    - `FileManager`: The only service authorized for filesystem operations.
- **Key Data Structures**:
    - **Activity Tree**: The hierarchical representation of the course structure, generated by CAM and managed by SN. This is a central data structure.
    - **SCORM Data Model**: The `cmi` object managed by the RTE.
    - **Telemetry Log**: A ring buffer of API calls and data model changes stored in `ScormInspectorTelemetryStore`. Change entries have the structure: `{ element, previousValue, newValue, source, timestamp, sessionId }`.

## 6. GUI (Renderer) Architecture

- **Core Principle**: The GUI is a **pure consumer of state**. It holds no business logic.
- **Service Layer**: The renderer has exactly four services: `AppManager` (orchestrator), `UIState` (state cache), `EventBus` (communication), and `ScormClient` (IPC). Do not add business logic here.
- **State Management**:
    - `UIState` is the **read-only** cache for all data needed by the UI.
    - Components **MUST NOT** have complex internal state. Use local variables only for transient view state (e.g., "is dropdown open").
- **Component Rules**:
    - All components **SHOULD** extend `BaseComponent` to inherit common functionality like event subscription management.
    - `ScormInspectorPanel`: **MUST NOT** use the `EventBus`. It receives its diagnostic data directly from the main process via dedicated IPC channels.
    - `ContentViewer`: Responsible for injecting the SCORM API bridge (`API_1484_11`) into the content iframe's window.

## 7. MCP (AI Agent Interface) Architecture

- **File Responsibilities**:
    - `node-bridge.js`: The main entry point. Handles JSON-RPC protocol over stdio ONLY. Contains no SCORM logic.
    - `electron-entry.js`: Spawned by the bridge. Hosts the Electron environment for running content.
    - `runtime-adapter.js`: Lives in the Electron process. Listens for IPC from the bridge and delegates to the SCORM engine.
    - `scorm-preload.js`: Injected into the content's WebView to provide the SCORM API.
- **Session Workspace**: All stateful operations occur within a session directory (`./sessions/<session_id>/`), which contains the unpacked course and any generated artifacts (screenshots, logs).
- **Error Model**: `SN_NOT_INITIALIZED` is **not an error**. It is an expected state for single-SCO courses. Tools will return `applicable: false` in this case.
- **Key Tool Categories (Overview)**:
    - **Session**: `scorm_session_open`, `scorm_session_close`.
    - **Validation**: `scorm_validate_workspace`, `scorm_lint_manifest`.
    - **Runtime Lifecycle**: `scorm_runtime_open`, `scorm_attempt_initialize`.
    - **Runtime Interaction**: `scorm_api_call`, `scorm_data_model_get`, `scorm_capture_screenshot`, `scorm_nav_get_state`.
    - **DOM & Browser Testing**: `scorm_dom_*` tools (click, fill, query, evaluate), `scorm_get_slide_map`, `scorm_navigate_to_slide` - pure DOM, no API dependencies.
    - **Template Automation**: `scorm_automation_*` tools require `window.SCORMAutomation` API - includes `scorm_automation_go_to_slide`, `scorm_automation_get_course_structure`.

### 7.2. Template Automation Tools

**Implementation**: All `scorm_automation_*` tools in `src/mcp/tools/automation.js` are thin wrappers around `scorm_dom_evaluate`. They construct JavaScript expressions that call `window.SCORMAutomation` methods.

**Behavior**:

- All tools check API availability first via `typeof window.SCORMAutomation !== "undefined"`
- If unavailable, throw `AUTOMATION_API_NOT_AVAILABLE` error immediately
- No automatic fallback to DOM tools - AI agent must explicitly choose between automation and DOM tools
- `scorm_automation_check_availability` must be called first to determine strategy
- Navigation: Use `scorm_automation_go_to_slide` for automation API, `scorm_navigate_to_slide` for pure DOM

**Error Codes**: `AUTOMATION_API_NOT_AVAILABLE`, `AUTOMATION_API_ERROR`, `INVALID_INTERACTION_ID`

**Tool Groups**:

- **Core**: Check availability, list/set/get/check interactions
- **Navigation**: Get structure/slide, navigate (requires `window.SCORMAutomation`)
- **Advanced**: Get correct answers, last evaluation, check slide answers
- **Debug**: Get/clear trace logs

### 7.3. Comprehensive List of MCP Tools

This section provides a complete, categorized list of all available MCP tools.

**Session Management:**
*   `scorm_session_open`
*   `scorm_session_status`
*   `scorm_session_events`
*   `scorm_session_close`

**Runtime Management:**
*   `scorm_runtime_open`
*   `scorm_runtime_status`
*   `scorm_runtime_close`

**SCORM API & Attempt Lifecycle:**
*   `scorm_attempt_initialize`
*   `scorm_attempt_terminate`
*   `scorm_api_call`
*   `scorm_data_model_get`

**Sequencing & Navigation (SN):**
*   `scorm_nav_get_state`
*   `scorm_nav_next`
*   `scorm_nav_previous`
*   `scorm_nav_choice`
*   `scorm_sn_init`
*   `scorm_sn_reset`

**Validation & Linting:**
*   `scorm_validate_workspace`
*   `scorm_lint_manifest`
*   `scorm_lint_api_usage`
*   `scorm_lint_sequencing`
*   `scorm_validate_compliance`

**Runtime Testing & Debugging:**
*   `scorm_test_api_integration`
*   `scorm_test_navigation_flow`
*   `scorm_debug_api_calls`
*   `scorm_trace_sequencing`
*   `scorm_get_data_model_history`
*   `scorm_assessment_interaction_trace`
*   `scorm_validate_data_model_state`
*   `scorm_get_console_errors`
*   `scorm_compare_data_model_snapshots`
*   `scorm_wait_for_api_call`
*   `scorm_get_current_page_context`
*   `scorm_replay_api_calls`

**Visual & DOM Interaction:**
*   `scorm_capture_screenshot`
*   `scorm_dom_click`
*   `scorm_dom_fill`
*   `scorm_dom_query`
*   `scorm_dom_evaluate`
*   `scorm_dom_wait_for`
*   `scorm_keyboard_type`
*   `scorm_get_network_requests`
*   `scorm_dom_find_interactive_elements`
*   `scorm_dom_fill_form_batch`

**Template Automation (requires compatible SCORM template with window.SCORMAutomation):**

*   `scorm_automation_check_availability`
*   `scorm_automation_list_interactions`
*   `scorm_automation_set_response`
*   `scorm_automation_check_answer`
*   `scorm_automation_get_response`
*   `scorm_automation_get_course_structure`
*   `scorm_automation_get_current_slide`
*   `scorm_automation_go_to_slide`
*   `scorm_automation_get_correct_response`
*   `scorm_automation_get_last_evaluation`
*   `scorm_automation_check_slide_answers`
*   `scorm_automation_get_trace`
*   `scorm_automation_clear_trace`

**Reporting:**
*   `scorm_report`

### 7.4. Token Efficiency & Data Retrieval Best Practices

To prevent excessive token usage, certain MCP tools return summary data by default and require explicit flags to retrieve full details:

**`scorm_get_data_model_history`:**

- **Default Behavior**: Returns `change_count`, `total_changes`, and `has_more` with a limit of 50 changes
- **Full Details**: Set `include_changes: true` to receive the complete `changes` array
- **Pagination**: Use `offset` and `limit` parameters for controlled data retrieval
- **Filtering**: Use `element_prefix`, `since_ts`, or `change_session_id` to narrow results

**`scorm_get_console_errors`:**

- **Default Behavior**: Returns `error_count` and categorized counts (scorm_api, syntax, runtime, network) with a limit of 50 errors
- **Full Details**: Set `include_errors: true` to receive the complete `errors` array
- **Filtering**: Use `severity` (error/warn/info) and `since_ts` to narrow results
- **Limit**: Specify `limit` parameter to control number of errors returned (default: 50)

**`system_get_logs`:**

- **Default Behavior**: Returns last 200 log entries
- **Control**: Use `tail` parameter to specify number of entries (default: 200)
- **Filtering**: Use `levels`, `since_ts`, and `component` to narrow results

AI agents **MUST** start with summary calls and only request full details when debugging specific issues.

## 8. Architectural Anti-Patterns (Forbidden)

- Placing business logic in the GUI (renderer) process.
- Placing SCORM logic anywhere outside the `main` process services.
- Creating redundant utility functions instead of using `src/shared/utils`.
- Using hardcoded strings for IPC channels or event names instead of `src/shared/constants`.
- Direct component-to-component method calls in the GUI (use `EventBus`).
- Using `console.log` instead of the shared logger.
- MCP clients parsing non-JSON output from `stdout`.
